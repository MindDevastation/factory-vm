{% extends "base.html" %}
{% block body %}
<h1>Factory VM</h1>
<p class="muted">Последние 200 jobs</p>
<p>
  <form method="post" action="/ui/jobs/render_all" style="display:inline-block;margin-right:12px;">
    <button type="submit">Render All</button>
  </form>
  <a href="/ui/jobs/create">Create Job</a>
</p>

<h2>Channels</h2>
<p>
  <button type="button" id="channel-add-btn">Add Channel</button>
  <span class="muted" id="channel-note"></span>
</p>
<div id="channel-form-wrap" style="display:none; margin-bottom:12px; border:1px solid #ddd; padding:12px;">
  <h3 style="margin-top:0;" id="channel-form-title">Add Channel</h3>
  <form id="channel-form">
    <label for="channel-slug">Slug</label>
    <input id="channel-slug" name="slug" type="text" required placeholder="my-channel" pattern="[a-z0-9-]{3,64}" />
    <label for="channel-display-name">Display name</label>
    <input id="channel-display-name" name="display_name" type="text" required placeholder="My Channel" />
    <button type="submit" id="channel-submit-btn">Create</button>
    <button type="button" id="channel-cancel-btn">Cancel</button>
  </form>
</div>
<table id="channels-table">
  <thead>
    <tr>
      <th>Display name</th>
      <th>Slug</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="3" class="muted">Loading channels...</td>
    </tr>
  </tbody>
</table>

<h2>OAuth Tokens</h2>
<p>
  <button type="button" id="oauth-refresh-btn">Refresh status</button>
  <span class="muted" id="oauth-refresh-note"></span>
</p>
<table id="oauth-status-table">
  <thead>
    <tr>
      <th>Channel</th>
      <th>Drive Token</th>
      <th>YouTube Token</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="4" class="muted">Loading token status...</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Канал</th>
      <th>Релиз</th>
      <th>State</th>
      <th>Stage</th>
      <th>Progress</th>
      <th>Updated</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for j in jobs %}
    <tr>
      <td><a href="/jobs/{{ j.id }}">{{ j.id }}</a></td>
      <td>{{ j.channel_name }}<div class="muted">{{ j.channel_slug }}</div></td>
      <td><a href="/jobs/{{ j.id }}">{{ j.channel_name }} - {{ j.release_title }}</a>
      {% if j.error_reason %}<div style="color:#b91c1c">{{ j.error_reason }}</div>{% endif %}</td>
      <td><span class="pill">{{ j.state }}</span></td>
      <td>{{ j.stage }}</td>
      <td>
        <div class="bar"><div style="width: {{ j.progress_pct }}%"></div></div>
        <div class="muted">{{ "%.1f"|format(j.progress_pct) }}% {{ j.progress_text or "" }}</div>
      </td>
      <td class="muted">{{ j.updated_at }}</td>
      <td>
        {% if j.state == 'DRAFT' and j.job_type == 'UI' %}
        <a href="/ui/jobs/{{ j.id }}/edit">Edit</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
(function () {
  const addBtn = document.getElementById('channel-add-btn');
  const formWrap = document.getElementById('channel-form-wrap');
  const channelForm = document.getElementById('channel-form');
  const formTitle = document.getElementById('channel-form-title');
  const slugInput = document.getElementById('channel-slug');
  const displayInput = document.getElementById('channel-display-name');
  const submitBtn = document.getElementById('channel-submit-btn');
  const cancelBtn = document.getElementById('channel-cancel-btn');
  const channelsTableBody = document.querySelector('#channels-table tbody');
  const channelNote = document.getElementById('channel-note');
  const refreshBtn = document.getElementById('oauth-refresh-btn');
  const refreshNote = document.getElementById('oauth-refresh-note');
  const oauthTableBody = document.querySelector('#oauth-status-table tbody');
  let pollCount = 0;
  let mode = 'create';
  let currentSlug = null;

  function fmtStatus(isPresent, mtime) {
    if (!isPresent) {
      return 'Missing';
    }
    if (!mtime) {
      return 'Present';
    }
    const dt = new Date(Number(mtime) * 1000);
    if (Number.isNaN(dt.getTime())) {
      return 'Present';
    }
    return 'Present (' + dt.toLocaleString() + ')';
  }

  async function startOauth(kind, slug) {
    const res = await fetch('/v1/oauth/' + kind + '/' + encodeURIComponent(slug) + '/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });
    if (!res.ok) {
      const body = await res.text();
      throw new Error('Failed to start OAuth: ' + body);
    }
    const data = await res.json();
    if (!data.auth_url) {
      throw new Error('Missing auth_url in response');
    }
    window.open(data.auth_url, '_blank', 'noopener');
  }

  function esc(value) {
    return String(value)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('\"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderRows(channels) {
    if (!channels.length) {
      oauthTableBody.innerHTML = '<tr><td colspan="4" class="muted">No channels found.</td></tr>';
      return;
    }

    oauthTableBody.innerHTML = channels.map((ch) => {
      return '<tr>' +
        '<td>' + esc(ch.display_name) + '<div class="muted">' + esc(ch.slug) + '</div></td>' +
        '<td>' + fmtStatus(ch.drive_token_present, ch.drive_token_mtime) + '</td>' +
        '<td>' + fmtStatus(ch.yt_token_present, ch.yt_token_mtime) + '</td>' +
        '<td>' +
          '<button type="button" data-kind="gdrive" data-slug="' + esc(ch.slug) + '">Generate Drive Token</button> ' +
          '<button type="button" data-kind="youtube" data-slug="' + esc(ch.slug) + '">Generate YouTube Token</button>' +
        '</td>' +
      '</tr>';
    }).join('');

    oauthTableBody.querySelectorAll('button[data-kind]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        try {
          refreshNote.textContent = 'Starting OAuth flow...';
          await startOauth(btn.getAttribute('data-kind'), btn.getAttribute('data-slug'));
          refreshNote.textContent = 'OAuth window opened. Complete consent, then wait for auto-refresh or click Refresh status.';
          pollCount = 0;
          pollStatus();
        } catch (err) {
          refreshNote.textContent = err.message;
        }
      });
    });
  }

  async function fetchStatus() {
    const res = await fetch('/v1/oauth/status');
    if (!res.ok) {
      const body = await res.text();
      throw new Error('Failed to load OAuth status: ' + body);
    }
    const data = await res.json();
    return data.channels || [];
  }

  async function refreshStatus() {
    try {
      const channels = await fetchStatus();
      renderRows(channels);
      refreshNote.textContent = 'Updated at ' + new Date().toLocaleTimeString();
    } catch (err) {
      refreshNote.textContent = err.message;
    }
  }

  function showForm(editMode, slug, displayName) {
    mode = editMode;
    currentSlug = slug || null;
    formWrap.style.display = 'block';
    formTitle.textContent = mode === 'rename' ? 'Rename Channel' : 'Add Channel';
    submitBtn.textContent = mode === 'rename' ? 'Rename' : 'Create';
    slugInput.value = slug || '';
    slugInput.disabled = mode === 'rename';
    displayInput.value = displayName || '';
    channelNote.textContent = '';
    displayInput.focus();
  }

  function hideForm() {
    formWrap.style.display = 'none';
    mode = 'create';
    currentSlug = null;
    channelForm.reset();
    slugInput.disabled = false;
  }

  async function fetchChannels() {
    const res = await fetch('/v1/channels');
    if (!res.ok) {
      if (res.status === 401) {
        throw new Error('Not authorized');
      }
      throw new Error('Failed to load channels');
    }
    return await res.json();
  }

  function renderChannels(channels) {
    if (!channels.length) {
      channelsTableBody.innerHTML = '<tr><td colspan="3" class="muted">No channels found.</td></tr>';
      return;
    }
    channelsTableBody.innerHTML = channels.map((ch) => {
      return '<tr>' +
        '<td>' + esc(ch.display_name) + '</td>' +
        '<td><code>' + esc(ch.slug) + '</code></td>' +
        '<td>' +
          '<button type="button" data-action="rename" data-slug="' + esc(ch.slug) + '" data-display-name="' + esc(ch.display_name) + '">Rename</button> ' +
          '<button type="button" data-action="delete" data-slug="' + esc(ch.slug) + '">Delete</button>' +
        '</td>' +
      '</tr>';
    }).join('');

    channelsTableBody.querySelectorAll('button[data-action="rename"]').forEach((btn) => {
      btn.addEventListener('click', () => {
        showForm('rename', btn.getAttribute('data-slug'), btn.getAttribute('data-display-name'));
      });
    });

    channelsTableBody.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const slug = btn.getAttribute('data-slug');
        if (!window.confirm('Delete channel "' + slug + '"?')) {
          return;
        }
        channelNote.textContent = '';
        try {
          const res = await fetch('/v1/channels/' + encodeURIComponent(slug), { method: 'DELETE' });
          if (!res.ok) {
            if (res.status === 401) {
              throw new Error('Not authorized');
            }
            if (res.status === 409) {
              throw new Error('Cannot delete channel: channel has jobs');
            }
            const body = await res.text();
            throw new Error('Failed to delete channel: ' + body);
          }
          channelNote.textContent = 'Channel deleted';
          await refreshAll();
        } catch (err) {
          channelNote.textContent = err.message;
        }
      });
    });
  }

  function validatePayload(slug, displayName) {
    if (!displayName.trim()) {
      return 'Display name is required';
    }
    if (mode === 'create') {
      if (!/^[a-z0-9-]{3,64}$/.test(slug)) {
        return 'Slug must match ^[a-z0-9-]{3,64}$';
      }
    }
    return '';
  }

  async function saveChannel() {
    const slug = slugInput.value.trim();
    const displayName = displayInput.value.trim();
    const validationError = validatePayload(slug, displayName);
    if (validationError) {
      channelNote.textContent = validationError;
      return;
    }

    channelNote.textContent = '';
    if (mode === 'create') {
      const res = await fetch('/v1/channels', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: slug, display_name: displayName }),
      });
      if (!res.ok) {
        if (res.status === 401) {
          throw new Error('Not authorized');
        }
        if (res.status === 409) {
          throw new Error('Channel slug already exists');
        }
        if (res.status === 422) {
          throw new Error('Invalid channel data. Check slug and display name.');
        }
        throw new Error('Failed to create channel');
      }
      channelNote.textContent = 'Channel created';
    } else {
      const res = await fetch('/v1/channels/' + encodeURIComponent(currentSlug), {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ display_name: displayName }),
      });
      if (!res.ok) {
        if (res.status === 401) {
          throw new Error('Not authorized');
        }
        if (res.status === 422) {
          throw new Error('Invalid display name');
        }
        throw new Error('Failed to rename channel');
      }
      channelNote.textContent = 'Channel renamed';
    }
    hideForm();
    await refreshAll();
  }

  async function refreshAll() {
    try {
      const channels = await fetchChannels();
      renderChannels(channels);
    } catch (err) {
      channelsTableBody.innerHTML = '<tr><td colspan="3" class="muted">' + esc(err.message) + '</td></tr>';
    }
    await refreshStatus();
  }

  function pollStatus() {
    if (pollCount >= 20) {
      return;
    }
    pollCount += 1;
    setTimeout(async () => {
      await refreshStatus();
      pollStatus();
    }, 3000);
  }

  addBtn.addEventListener('click', () => showForm('create'));
  cancelBtn.addEventListener('click', hideForm);
  channelForm.addEventListener('submit', async (evt) => {
    evt.preventDefault();
    try {
      await saveChannel();
    } catch (err) {
      channelNote.textContent = err.message;
    }
  });
  refreshBtn.addEventListener('click', refreshAll);
  refreshAll();
})();
</script>
{% endblock %}
